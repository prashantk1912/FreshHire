<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Seeker Dashboard - FreshHire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Apply the consistent background gradient */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #e0f2fe, #f3e8ff);
        }
        /* Custom styles for rounded corners */
        .rounded, .rounded-lg, .rounded-md, .rounded-xl {
            border-radius: 0.5rem;
        }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .hover\:shadow-xl:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .transition { transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }

        /* Custom scrollbar styles */
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px; /* width of the scrollbar */
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1; /* color of the tracking area */
            border-radius: 10px;
        }
        .scrollbar-thumb-blue-500::-webkit-scrollbar-thumb {
            background-color: #3b82f6; /* color of the scroll thumb */
            border-radius: 10px; /* roundness of the scroll thumb */
            border: 2px solid #f1f1f1; /* creates padding around scroll thumb */
        }
        .scrollbar-thumb-blue-500::-webkit-scrollbar-thumb:hover {
            background-color: #2563eb; /* color of the scroll thumb on hover */
        }
    </style>
    <!-- Firebase SDKs for Auth and App, and Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
</head>
<body class="flex flex-col justify-center items-center min-h-screen p-4">
    <!-- Main content area for the dashboard -->
    <div id="dashboardContent" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-5xl text-center hidden relative">
        <!-- Top bar with Welcome message, email, and Profile button -->
        <div class="flex flex-col md:flex-row md:justify-between items-center mb-6 border-b pb-4 relative">
            <div class="md:absolute md:left-1/2 md:-translate-x-1/2 md:w-auto w-full text-center">
                <h1 class="text-3xl font-bold text-blue-700" id="welcomeMessage">Welcome, Job Seeker!</h1>
                <p class="text-gray-700 text-lg" id="userEmailDisplay"></p>
            </div>
            <div class="md:ml-auto mt-4 md:mt-0">
                <button id="profileButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                    <!-- Default user icon (inline SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0a4.5 4.5 0 0 1 -9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1 -.437 .695A18.623 18.623 0 0 1 12 22.5a18.623 18.623 0 0 1 -7.813 -1.69a.75.75 0 0 1 -.437 -.695Z" clip-rule="evenodd" />
                    </svg>
                    <span>My Profile</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Column: Job Listings -->
            <div class="col-span-1">
                <section class="p-6 border border-gray-200 rounded-lg bg-gray-50 shadow-sm mb-8 md:mb-0">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Available Job Postings</h2>

                    <!-- Search and Filter Inputs -->
                    <div class="mb-4 space-y-3">
                        <input type="text" id="jobSearchKeywords" placeholder="Search by title or description" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                        <input type="text" id="jobSearchLocation" placeholder="Filter by location (e.g., Remote, City)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                    </div>

                    <div id="availableJobListings" class="space-y-4 text-left max-h-96 overflow-y-auto pr-2 scrollbar-thumb-blue-500 scrollbar-track-blue-100 scrollbar-thin">
                        <p class="text-gray-500 text-center">Loading job postings...</p>
                    </div>
                </section>
            </div>

            <!-- Right Column: Applied Jobs & Saved Jobs -->
            <div class="col-span-1 flex flex-col space-y-8">
                <!-- Applied Jobs Section -->
                <section class="p-6 border border-gray-200 rounded-lg bg-gray-50 shadow-sm flex-grow">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Applications</h2>
                    <div id="appliedJobListings" class="space-y-4 text-left max-h-72 overflow-y-auto pr-2 scrollbar-thin">
                        <p class="text-gray-500 text-center">You haven't applied for any jobs yet.</p>
                    </div>
                </section>

                <!-- Saved Jobs Section (New) -->
                <section class="p-6 border border-gray-200 rounded-lg bg-gray-50 shadow-sm flex-grow">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Saved Jobs</h2>
                    <div id="savedJobListings" class="space-y-4 text-left max-h-72 overflow-y-auto pr-2 scrollbar-thin">
                        <p class="text-gray-500 text-center">You haven't saved any jobs yet.</p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Logout Button -->
        <div class="mt-8">
            <a href="#" id="logoutLink" class="text-blue-600 hover:underline font-medium">Logout</a>
        </div>
    </div>

    <!-- My Profile Modal -->
    <div id="profileModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-xl w-full relative">
            <button id="closeProfileModal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl font-bold">
                &times;
            </button>
            <h2 class="text-3xl font-bold text-blue-700 mb-6 text-center">My Profile</h2>
            <form id="profileForm" class="space-y-4 text-left">
                <div>
                    <label for="seekerName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="seekerName" placeholder="Full Name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                    <label for="seekerGender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="seekerGender" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="universityName" class="block text-sm font-medium text-gray-700">University Name</label>
                    <input type="text" id="universityName" placeholder="Your University" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                    <label for="courseName" class="block text-sm font-medium text-gray-700">Course</label>
                    <input type="text" id="courseName" placeholder="e.g., B.Tech, M.Sc" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                    <label for="branchName" class="block text-sm font-medium text-gray-700">Branch</label>
                    <input type="text" id="branchName" placeholder="e.g., Computer Science, Electrical" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                    <label for="cgpa" class="block text-sm font-medium text-gray-700">CGPA</label>
                    <input type="number" id="cgpa" step="0.01" placeholder="e.g., 8.5" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                    <label for="graduationYear" class="block text-sm font-medium text-gray-700">Graduation Year</label>
                    <input type="number" id="graduationYear" placeholder="e.g., 2025" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <div>
                    <label for="seekerLocation" class="block text-sm font-medium text-gray-700">Location</label>
                    <input type="text" id="seekerLocation" placeholder="Your Current City" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-semibold">Save Profile</button>
            </form>
            <p id="profileMessage" class="mt-2 text-sm text-center hidden"></p>
        </div>
    </div>

    <!-- Loading/Unauthorized message -->
    <div id="messageContainer" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md text-center">
        <p id="statusMessage" class="text-lg text-gray-600">Checking authentication status...</p>
    </div>

    <script type="module">
        // Your Firebase config (UPDATED for FreshHire-V2)
        const firebaseConfig = {
            apiKey: "AIzaSyDM7usECuavmk9XQmsMlrmazdazzRNr7qc",
            authDomain: "freshhire-v2.firebaseapp.com",
            projectId: "freshhire-v2",
            storageBucket: "freshhire-v2.firebasestorage.app",
            messagingSenderId: "747621620674",
            appId: "1:747621620674:web:3576dc06b0d4dc07ef545b",
            measurementId: "G-XW34DBSN4H"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        // ADDED arrayUnion and arrayRemove to the import list for Firestore
        import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get references to DOM elements
        const dashboardContent = document.getElementById("dashboardContent");
        const messageContainer = document.getElementById("messageContainer");
        const statusMessage = document.getElementById("statusMessage");
        const userEmailDisplay = document.getElementById("userEmailDisplay");
        const logoutLink = document.getElementById("logoutLink");
        const welcomeMessage = document.getElementById("welcomeMessage");

        // Profile button and modal elements
        const profileButton = document.getElementById("profileButton");
        const profileModal = document.getElementById("profileModal");
        const closeProfileModalButton = document.getElementById("closeProfileModal");

        // Job Listings elements
        const availableJobListingsDiv = document.getElementById("availableJobListings");
        const appliedJobListingsDiv = document.getElementById("appliedJobListings");
        const savedJobListingsDiv = document.getElementById("savedJobListings"); // New: Saved jobs section

        // Search inputs
        const jobSearchKeywordsInput = document.getElementById("jobSearchKeywords");
        const jobSearchLocationInput = document.getElementById("jobSearchLocation");

        // Profile Form elements
        const profileForm = document.getElementById("profileForm");
        const seekerNameInput = document.getElementById("seekerName");
        const seekerGenderSelect = document.getElementById("seekerGender");
        const universityNameInput = document.getElementById("universityName");
        const courseNameInput = document.getElementById("courseName");
        const branchNameInput = document.getElementById("branchName");
        const cgpaInput = document.getElementById("cgpa");
        const graduationYearInput = document.getElementById("graduationYear");
        const seekerLocationInput = document.getElementById("seekerLocation");
        const profileMessage = document.getElementById("profileMessage");

        let currentSeekerId = null;
        let appliedJobIds = new Set();
        let savedJobIds = new Set(); // New: To keep track of saved jobs
        let allAvailableJobs = []; // To store all jobs for client-side filtering
        let allSavedJobs = []; // New: To store details of saved jobs for rendering

        // --- Helper function to show a temporary message ---
        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.toggle('text-red-600', isError);
            element.classList.toggle('text-green-600', !isError);
            setTimeout(() => {
                element.classList.add('hidden');
                element.textContent = '';
            }, 3000);
        }

        // --- Function to populate profile form with user data ---
        function populateProfileForm(userData) {
            if (userData.profile) {
                seekerNameInput.value = userData.profile.name || '';
                seekerGenderSelect.value = userData.profile.gender || '';
                universityNameInput.value = userData.profile.university || '';
                courseNameInput.value = userData.profile.course || '';
                branchNameInput.value = userData.profile.branch || '';
                cgpaInput.value = userData.profile.cgpa || '';
                graduationYearInput.value = userData.profile.graduationYear || '';
                seekerLocationInput.value = userData.profile.location || '';
            } else {
                profileForm.reset();
            }
            showMessage(profileMessage, '');
        }

        // --- Function to update the welcome message with seeker's name ---
        function updateWelcomeMessage(name) {
            if (name && name.trim() !== '') {
                welcomeMessage.textContent = `Welcome, ${name}!`;
            } else {
                welcomeMessage.textContent = `Welcome, Job Seeker!`;
            }
        }

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentSeekerId = user.uid;
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.role === "seeker") {
                            userEmailDisplay.textContent = `${user.email}`;
                            messageContainer.classList.add("hidden");
                            dashboardContent.classList.remove("hidden");

                            populateProfileForm(userData);
                            updateWelcomeMessage(userData.profile?.name);

                            // Initial load of jobs and applications/saved jobs
                            listenForAppliedJobs(currentSeekerId);
                            listenForSavedJobs(currentSeekerId); // New: Listen for saved jobs
                            listenForAllJobPostingsFromFirestore();
                        } else {
                            statusMessage.textContent = "Access Denied: You are not authorized as a Job Seeker. Redirecting...";
                            dashboardContent.classList.add("hidden");
                            messageContainer.classList.remove("hidden");
                            setTimeout(() => {
                                signOut(auth);
                                window.location.href = "login-select.html";
                            }, 3000);
                        }
                    } else {
                        statusMessage.textContent = "User data not found. Please re-login. Redirecting...";
                        dashboardContent.classList.add("hidden");
                        messageContainer.classList.remove("hidden");
                        setTimeout(() => {
                            signOut(auth);
                            window.location.href = "login-select.html";
                        }, 3000);
                    }
                } catch (error) {
                    console.error("Error fetching user role or profile:", error);
                    statusMessage.textContent = "Error checking user role. Please try again. Redirecting...";
                    dashboardContent.classList.add("hidden");
                    messageContainer.classList.remove("hidden");
                    setTimeout(() => {
                        signOut(auth);
                        window.location.href = "login-select.html";
                    }, 3000);
                }
            } else {
                statusMessage.textContent = "You are not logged in. Redirecting...";
                dashboardContent.classList.add("hidden");
                messageContainer.classList.remove("hidden");
                setTimeout(() => {
                    window.location.href = "login-select.html";
                }, 2000);
            }
        });

        // --- Logout Event Listener ---
        logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
                window.location.href = "login-select.html";
            } catch (error) {
                console.error("Error signing out:", error);
                showMessage(userEmailDisplay, "Error signing out: " + error.message, true);
            }
        });

        // --- Profile Button & Modal Handlers ---
        profileButton.addEventListener('click', () => {
            profileModal.classList.remove('hidden');
        });

        closeProfileModalButton.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });

        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.classList.add('hidden');
            }
        });


        // --- Save Seeker Profile ---
        profileForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!currentSeekerId) {
                showMessage(profileMessage, "Error: User not authenticated. Please refresh.", true);
                return;
            }

            const profileData = {
                name: seekerNameInput.value.trim(),
                gender: seekerGenderSelect.value,
                university: universityNameInput.value.trim(),
                course: courseNameInput.value.trim(),
                branch: branchNameInput.value.trim(),
                cgpa: parseFloat(cgpaInput.value) || null,
                graduationYear: parseInt(graduationYearInput.value) || null,
                location: seekerLocationInput.value.trim()
            };

            try {
                const userDocRef = doc(db, "users", currentSeekerId);
                await updateDoc(userDocRef, {
                    profile: profileData
                });
                showMessage(profileMessage, "Profile saved successfully!");
                profileModal.classList.add('hidden');
                updateWelcomeMessage(profileData.name);
            } catch (error) {
                console.error("Error saving profile:", error);
                showMessage(profileMessage, "Error saving profile: " + error.message, true);
            }
        });

        // --- Debounce function for search inputs ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // --- Function to render jobs based on current filters and saved status ---
        function renderFilteredJobs() {
            const keywords = jobSearchKeywordsInput.value.toLowerCase().trim();
            const location = jobSearchLocationInput.value.toLowerCase().trim();

            let filteredJobs = allAvailableJobs;

            if (keywords) {
                filteredJobs = filteredJobs.filter(job =>
                    job.title.toLowerCase().includes(keywords) ||
                    job.description.toLowerCase().includes(keywords)
                );
            }

            if (location) {
                filteredJobs = filteredJobs.filter(job =>
                    job.location && job.location.toLowerCase().includes(location)
                );
            }

            availableJobListingsDiv.innerHTML = ''; // Clear previous listings

            if (filteredJobs.length === 0) {
                availableJobListingsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No jobs matching your search criteria.</p>';
                return;
            }

            // Sort jobs by timestamp in descending order before rendering
            filteredJobs.sort((a, b) => {
                if (a.timestamp && b.timestamp) {
                    return b.timestamp.toMillis() - a.timestamp.toMillis();
                }
                return 0;
            });

            filteredJobs.forEach((job) => {
                const isApplied = appliedJobIds.has(job.id);
                const isSaved = savedJobIds.has(job.id); // New: Check if job is saved

                const jobElement = document.createElement('div');
                jobElement.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'flex', 'flex-col', 'md:flex-row', 'justify-between', 'items-start', 'md:items-center', 'space-y-2', 'md:space-y-0');

                const timestampDate = job.timestamp ? new Date(job.timestamp.toMillis()).toLocaleDateString() : 'N/A';

                jobElement.innerHTML = `
                    <div class="text-left flex-grow">
                        <h3 class="text-xl font-semibold text-gray-900">${job.title}</h3>
                        <p class="text-gray-700 mt-1 line-clamp-3">${job.description}</p>
                        <p class="text-sm text-gray-500 mt-2">
                            ${job.location ? `Location: ${job.location} | ` : ''} Posted: ${timestampDate}
                        </p>
                    </div>
                    <div class="flex-shrink-0 mt-3 md:mt-0 flex space-x-2 items-center">
                        ${isApplied ?
                            `<span class="bg-green-100 text-green-700 px-4 py-2 rounded-lg font-medium text-sm">Applied!</span>` :
                            `<button data-job-id="${job.id}"
                                     data-job-title="${job.title}"
                                     class="apply-job-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                                Apply
                            </button>`
                        }
                        <button data-job-id="${job.id}"
                                class="save-job-btn px-4 py-2 rounded-lg font-medium text-sm transition
                                        ${isSaved ? 'bg-gray-200 text-gray-700 hover:bg-gray-300' : 'bg-yellow-500 text-white hover:bg-yellow-600'}">
                            ${isSaved ? 'Saved!' : 'Save Job'}
                        </button>
                    </div>
                `;
                availableJobListingsDiv.appendChild(jobElement);
            });
        }


        // --- Listen for ALL Job Postings from Firestore ---
        function listenForAllJobPostingsFromFirestore() {
            const q = query(collection(db, "jobPostings"));
            onSnapshot(q, (snapshot) => {
                allAvailableJobs = [];
                if (!snapshot.empty) {
                    snapshot.forEach((doc) => {
                        allAvailableJobs.push({ id: doc.id, ...doc.data() });
                    });
                }
                renderFilteredJobs(); // Now render with current filters (and saved status)
            }, (error) => {
                console.error("Error listening for all job postings:", error);
                availableJobListingsDiv.innerHTML = '<p class="text-red-600 text-center py-4">Error loading jobs. Please try again.</p>';
            });
        }


        // --- Listen for Applied Jobs (for current seeker) ---
        function listenForAppliedJobs(seekerId) {
            const q = query(collection(db, "applications"), where("seekerId", "==", seekerId));
            onSnapshot(q, (snapshot) => {
                appliedJobListingsDiv.innerHTML = '';
                appliedJobIds.clear();

                if (snapshot.empty) {
                    appliedJobListingsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">You haven\'t applied for any jobs yet.</p>';
                    renderFilteredJobs(); // Re-render available jobs to clear any 'Applied!' labels if applications were deleted
                    return;
                }

                let appliedJobs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    appliedJobs.push({ id: data.jobId, ...data, docId: doc.id }); // Store Firestore document ID
                    appliedJobIds.add(data.jobId);
                });

                renderFilteredJobs(); // Re-render available jobs after updating appliedJobIds

                appliedJobs.sort((a, b) => {
                    if (a.applicationDate && b.applicationDate) {
                        return b.applicationDate.toMillis() - a.applicationDate.toMillis();
                    }
                    return 0;
                });

                appliedJobs.forEach((application) => {
                    const jobElement = document.createElement('div');
                    jobElement.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'mb-2', 'text-left');

                    const applyDate = application.applicationDate ? new Date(application.applicationDate.toMillis()).toLocaleDateString() : 'N/A';

                    jobElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${application.jobTitle || 'Unknown Job'}</h3>
                                <p class="text-sm text-gray-600">Applied on: ${applyDate}</p>
                                <p class="text-sm text-gray-600">Status: <span class="font-medium text-blue-700">${application.status || 'Pending'}</span></p>
                            </div>
                            <button data-app-id="${application.docId}" class="withdraw-application-btn bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition font-medium text-sm">
                                Withdraw
                            </button>
                        </div>
                    `;
                    appliedJobListingsDiv.appendChild(jobElement);
                });
            }, (error) => {
                console.error("Error listening for applied jobs:", error);
                appliedJobListingsDiv.innerHTML = '<p class="text-red-600 text-center py-4">Error loading your applications. Please try again.</p>';
            });
        }

        // --- Listen for Saved Jobs (New) ---
        function listenForSavedJobs(seekerId) {
            const userDocRef = doc(db, "users", seekerId);
            onSnapshot(userDocRef, (docSnapshot) => {
                savedJobListingsDiv.innerHTML = ''; // Clear previous listings
                savedJobIds.clear(); // Clear existing saved job IDs
                allSavedJobs = []; // Clear array for detailed saved jobs

                if (docSnapshot.exists()) {
                    const userData = docSnapshot.data();
                    const savedJobIdsArray = userData.savedJobs || []; // Get the array of saved job IDs

                    if (savedJobIdsArray.length > 0) {
                        savedJobIdsArray.forEach(jobId => savedJobIds.add(jobId)); // Populate set

                        // Fetch details for each saved job
                        // Note: This creates a separate getDoc call for each saved job.
                        // For very large numbers of saved jobs, consider a batched get.
                        const jobFetches = savedJobIdsArray.map(jobId =>
                            getDoc(doc(db, "jobPostings", jobId))
                        );

                        Promise.all(jobFetches).then(jobDocs => {
                            jobDocs.forEach(jobDoc => {
                                if (jobDoc.exists()) {
                                    allSavedJobs.push({ id: jobDoc.id, ...jobDoc.data() });
                                }
                            });
                            // Sort saved jobs by timestamp (or another criteria)
                            allSavedJobs.sort((a, b) => {
                                if (a.timestamp && b.timestamp) {
                                    return b.timestamp.toMillis() - a.timestamp.toMillis();
                                }
                                return 0;
                            });

                            if (allSavedJobs.length === 0) {
                                savedJobListingsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No saved jobs found.</p>';
                            } else {
                                allSavedJobs.forEach(job => {
                                    const jobElement = document.createElement('div');
                                    jobElement.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'mb-2', 'text-left');
                                    const timestampDate = job.timestamp ? new Date(job.timestamp.toMillis()).toLocaleDateString() : 'N/A';

                                    jobElement.innerHTML = `
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <h3 class="text-lg font-semibold text-gray-900">${job.title}</h3>
                                                <p class="text-sm text-gray-700 mt-1 line-clamp-2">${job.description}</p>
                                                <p class="text-sm text-gray-500 mt-2">
                                                    ${job.location ? `Location: ${job.location} | ` : ''} Posted: ${timestampDate}
                                                </p>
                                            </div>
                                            <button data-job-id="${job.id}"
                                                    class="unsave-job-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition font-medium text-sm">
                                                Unsave
                                            </button>
                                        </div>
                                    `;
                                    savedJobListingsDiv.appendChild(jobElement);
                                });
                            }
                        }).catch(error => {
                            console.error("Error fetching saved job details:", error);
                            savedJobListingsDiv.innerHTML = '<p class="text-red-600 text-center py-4">Error loading saved jobs.</p>';
                        });

                    } else {
                        savedJobListingsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">You haven\'t saved any jobs yet.</p>';
                    }
                } else {
                    savedJobListingsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Your user profile not found for saved jobs.</p>';
                }
                renderFilteredJobs(); // Re-render available jobs as saved status might have changed
            }, (error) => {
                console.error("Error listening for user saved jobs:", error);
                savedJobListingsDiv.innerHTML = '<p class="text-red-600 text-center py-4">Error loading saved jobs. Please try again.</p>';
            });
        }


        // --- Event Delegation for Apply Button ---
        availableJobListingsDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('apply-job-btn')) {
                const jobId = e.target.dataset.jobId;
                const jobTitle = e.target.dataset.jobTitle;

                if (!currentSeekerId) {
                    showMessage(userEmailDisplay, "Error: You must be logged in to apply.", true);
                    return;
                }

                if (appliedJobIds.has(jobId)) {
                    showMessage(userEmailDisplay, "You have already applied for this job.", false);
                    return;
                }

                showMessage(userEmailDisplay, "Submitting application...", false);
                e.target.disabled = true; // Disable button to prevent multiple clicks

                try {
                    await addDoc(collection(db, "applications"), {
                        jobId: jobId,
                        jobTitle: jobTitle,
                        seekerId: currentSeekerId,
                        applicationDate: serverTimestamp(),
                        status: "Applied"
                    });
                    showMessage(userEmailDisplay, "Application submitted successfully!");
                } catch (error) {
                    console.error("Error submitting application:", error);
                    showMessage(userEmailDisplay, "Error submitting application: " + error.message, true);
                } finally {
                    e.target.disabled = false; // Re-enable button
                }
            }
            // --- Handle Save/Unsave Job Button (New) ---
            else if (e.target.classList.contains('save-job-btn')) {
                const jobId = e.target.dataset.jobId;
                const isSaved = savedJobIds.has(jobId);
                const userDocRef = doc(db, "users", currentSeekerId);

                if (!currentSeekerId) {
                    showMessage(userEmailDisplay, "Error: You must be logged in to save jobs.", true);
                    return;
                }

                showMessage(userEmailDisplay, `${isSaved ? 'Unsaving' : 'Saving'} job...`, false);
                e.target.disabled = true;

                try {
                    if (isSaved) {
                        await updateDoc(userDocRef, {
                            savedJobs: arrayRemove(jobId)
                        });
                        showMessage(userEmailDisplay, "Job unsaved!", false);
                    } else {
                        await updateDoc(userDocRef, {
                            savedJobs: arrayUnion(jobId)
                        });
                        showMessage(userEmailDisplay, "Job saved!", false);
                    }
                } catch (error) {
                    console.error("Error saving/unsaving job:", error);
                    showMessage(userEmailDisplay, `Error ${isSaved ? 'unsaving' : 'saving'} job: ` + error.message, true);
                } finally {
                    e.target.disabled = false;
                }
            }
        });

        // --- Event Delegation for Withdraw Application Button ---
        appliedJobListingsDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('withdraw-application-btn')) {
                const appIdToDelete = e.target.dataset.appId;

                if (!appIdToDelete) {
                    showMessage(userEmailDisplay, "Error: Could not find application ID to withdraw.", true);
                    return;
                }

                showMessage(userEmailDisplay, "Withdrawing application...", false);
                e.target.disabled = true;

                try {
                    await deleteDoc(doc(db, "applications", appIdToDelete));
                    showMessage(userEmailDisplay, "Application withdrawn successfully!");
                } catch (error) {
                    console.error("Error withdrawing application:", error);
                    showMessage(userEmailDisplay, "Error withdrawing application: " + error.message, true);
                } finally {
                    e.target.disabled = false;
                }
            }
        });

        // --- Event Delegation for Unsave Job Button (New) ---
        savedJobListingsDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('unsave-job-btn')) {
                const jobIdToUnsave = e.target.dataset.jobId;
                const userDocRef = doc(db, "users", currentSeekerId);

                if (!currentSeekerId || !jobIdToUnsave) {
                    showMessage(userEmailDisplay, "Error: You must be logged in to unsave jobs, or job ID is missing.", true);
                    return;
                }

                showMessage(userEmailDisplay, "Unsaving job...", false);
                e.target.disabled = true;

                try {
                    await updateDoc(userDocRef, {
                        savedJobs: arrayRemove(jobIdToUnsave)
                    });
                    showMessage(userEmailDisplay, "Job unsaved!", false);
                } catch (error) {
                    console.error("Error unsaving job:", error);
                    showMessage(userEmailDisplay, "Error unsaving job: " + error.message, true);
                } finally {
                    e.target.disabled = false;
                }
            }
        });

        // --- Search Input Event Listeners ---
        const debouncedRenderJobs = debounce(renderFilteredJobs, 300);

        jobSearchKeywordsInput.addEventListener('input', debouncedRenderJobs);
        jobSearchLocationInput.addEventListener('input', debouncedRenderJobs);
    </script>
</body>
</html>
